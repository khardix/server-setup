# Master playbook file â€“ complete setup of fresh machine
---
- hosts: all
  become: true
  gather_facts: false

  pre_tasks:
    - name: Find usable SSH port
      when: ansible_port is defined
      vars:
        candidate_ssh_ports: ['{{ ansible_port }}', 22]
      include_tasks:
        file: tasks/test-ssh-port.yml
        apply: {tags: [always]}
      tags: [always]
    - name: Provide remote_tmp dir
      changed_when: false  # Do not care
      raw: 'mkdir -p /run/ansible && chmod 0777 /run/ansible'
    - name: Bootstrap the machine
      changed_when: false  # Unsupported
      script: tasks/bootstrap.sh
    - name: Gather facts
      setup: ~

  roles:
    - role: khardix.core
    - role: khardix.firewall
    - role: khardix.remote-shell
    - role: khardix.users

- hosts: minecraft
  become: true
  gather_facts: false
  roles:
    - role: khardix.minecraft
...
